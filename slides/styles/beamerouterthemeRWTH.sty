\mode<presentation>

\RequirePackage{calc}
\RequirePackage{graphicx}
\RequirePackage{tikz}
\usetikzlibrary{calc}

% \framelinewidth is width of frame elements like title, text and separator lines
\newlength{\framelinewidth}
\setlength{\framelinewidth}{\paperwidth-20mm}
% \foottextwidth is width of footer text (now full width without logo)
\newlength{\foottextwidth}
\setlength{\foottextwidth}{\paperwidth-31.2mm-8.5mm}

% Maxbox: Ensure #3 is no wider than #1 and taller than #2
\providecommand{\maxbox}[3]{%
  \setbox9=\hbox{{#3}}%
  \ifdim\wd9>#1
    \setbox9=\hbox{\resizebox{#1}{!}{#3}}%
  \else
    {}%
  \fi%
  \ifdim\ht9>#2
    \setbox9=\hbox{\resizebox{!}{#2}{\usebox9}}%
  \else
    {}%
  \fi%
  \usebox9
}

\newcommand{\nempty}[3]{\ifx#1\empty#3{}\else#2{}\fi}

% Progress bar for footer
\newdimen\progressbar@pbht
\setlength{\progressbar@pbht}{5pt}

\defbeamertemplate*{progress bar}{rwth}{%
  \begin{tikzpicture}%
    % Safe calculation: avoid division by zero and clamp to [0,1]
    \pgfmathsetmacro{\progresspercent}{0}%
    \ifnum\inserttotalframenumber>0
      \pgfmathsetmacro{\progresspercent}{\insertframenumber/\inserttotalframenumber}%
    \fi
    \pgfmathsetmacro{\progresspercent}{min(1,max(0,\progresspercent))}%
    \fill[color=rwth-10] (0,0) rectangle (\framelinewidth, \progressbar@pbht);%
    \fill[color=rwth] (0,0) rectangle (\progresspercent*\framelinewidth, \progressbar@pbht);%
  \end{tikzpicture}%
}

% Command building footer
\defbeamertemplate*{footertext}{rwth}{
\nempty{\inserttitle}{\inserttitle{}\enskip|\enskip}{}%
\nempty{\insertauthor}{\insertauthor{}\enskip|\enskip}{}%
\nempty{\insertlocation}{\insertlocation{}\enskip--\enskip}{}%
\insertdate
}

% Custom footer text and command
\defbeamertemplate*{footertextextra}{rwth}{}

\setlength{\headsep}{0pt}

\makeatletter
\newlength\leftmarrr
\setlength{\leftmarrr}{\beamer@leftmargin}
\makeatother

\makeatletter
\define@key{beamerframe}{t}[true]{% top
  \beamer@frametopskip=0pt\relax%
  \beamer@framebottomskip=0pt plus 1fill\relax%
  \beamer@frametopskipautobreak=\beamer@frametopskip\relax%
  \beamer@framebottomskipautobreak=\beamer@framebottomskip\relax%
  \def\beamer@initfirstlineunskip{%
    \def\beamer@firstlineitemizeunskip{%
      \vskip-\partopsep\vskip-\topsep\vskip-\parskip%
      \global\let\beamer@firstlineitemizeunskip=\relax}%
    \everypar{\global\let\beamer@firstlineitemizeunskip=\relax}}
}
\makeatother

%%%
% Header
%%%
\defbeamertemplate*{headline}{rwth}{
\vspace{5.7mm}
\hbox{%
%
  \hspace*{8mm}%
%
\begin{beamercolorbox}[wd=\framelinewidth,ht=13mm]{section in head/foot}%
\usebeamerfont{section in head/foot}\insertsectionhead\strut%
\end{beamercolorbox}%
%
  \hspace*{8mm}%
%
}%
\vspace{1.9mm}
\hspace*{8mm}\begin{beamercolorbox}[wd=\framelinewidth,colsep=0.25pt]{separation line}
\end{beamercolorbox}%
% Logo at top right
\begin{tikzpicture}[overlay, remember picture]
  \node[anchor=north east, inner sep=8mm] at (current page.north east) {
    % University logo only - RWTH i5 branding
    \maxbox{100mm}{15mm}{\includegraphics[keepaspectratio]{\insertuniversitylogo}}%
  };
\end{tikzpicture}
\vskip-\partopsep\vskip-\topsep\vskip-\parskip
\vskip9.4mm
\vskip1mm
}

%%%
% Frame title
%%%
\defbeamertemplate*{frametitle}{rwth}
{
\vskip-9mm
\hspace{-\leftmarrr}
\hspace{8mm}
\begin{beamercolorbox}[wd=\framelinewidth,ht=7mm]{frametitle}
\usebeamerfont{frametitle}\insertframetitle%
\end{beamercolorbox}
\vskip0.2em
}

%%%
% Footer
%%%
\defbeamertemplate*{footline}{rwth}{
%\vspace{5.7mm} % Minimum space between content and footer, not really required
% Separation line
\hspace*{8mm}\begin{beamercolorbox}[wd=\framelinewidth,colsep=0.25pt]{separation line}
\end{beamercolorbox}%

\hbox{%
%
  \hspace*{8mm}%
%
  \parbox[b]{20.2mm}{%
    \vspace{3mm}%
    \begin{beamercolorbox}[wd=20.2mm,ht=7mm]{page number in head/foot}%
    \usebeamerfont{page number in head/foot}%
    \vbox to7mm{\insertframenumber{} of \inserttotalframenumber\vfil{}}%
    \end{beamercolorbox}%
    \vspace{3mm}%
  }%
%
  \hspace*{3mm}%
  \parbox[b]{\foottextwidth}{%
    \vspace{3mm}%
    \begin{beamercolorbox}[wd=\foottextwidth,ht=7mm]{text in head/foot}%
    \usebeamerfont{text in head/foot}%
    \vbox to7mm{\usebeamertemplate{footertext}
    \vfil{}}%
    \end{beamercolorbox}%
    \vspace{3mm}%
  }%
%
  \hspace*{4.5mm}%
%
}%
% Progress bar at the bottom
\vspace{1.5mm}%
\hbox{%
  \hspace*{8mm}\usebeamertemplate{progress bar}%
}%
}

\defbeamertemplate*{sidebar left}{rwth}{}
\defbeamertemplate*{sidebar right}{rwth}{}
\setbeamersize{sidebar width left=0pt}
\setbeamersize{sidebar width right=0pt}
\defbeamertemplate*{navigation symbols}{rwth}{}

\mode<all>